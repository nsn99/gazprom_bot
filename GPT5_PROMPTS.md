# Система промптов для GPT-5 анализа GAZP

## Обзор

Система промптов разработана для эффективного взаимодействия с GPT-5 через AgentRouter для анализа акций Газпрома и генерации торговых рекомендаций. Промпты структурированы для обеспечения последовательности, точности и соответствия регуляторным требованиям.

## Архитектура системы промптов

```mermaid
graph TB
    subgraph "Prompt System"
        SP[System Prompt]
        AP[Analysis Prompt]
        RP[Recommendation Prompt]
        VP[Validation Prompt]
        EP[Explanation Prompt]
    end
    
    subgraph "Context Data"
        PD[Portfolio Data]
        MD[Market Data]
        TI[Technical Indicators]
        FI[Fundamental Info]
        MH[Market History]
    end
    
    subgraph "Output Formats"
        AF[Analysis Format]
        RF[Recommendation Format]
        VF[Validation Format]
        EF[Explanation Format]
    end
    
    SP --> AP
    AP --> RP
    RP --> VP
    VP --> EP
    
    PD --> AP
    MD --> AP
    TI --> AP
    FI --> AP
    MH --> AP
    
    AP --> AF
    RP --> RF
    VP --> VF
    EP --> EF
```

## Базовый системный промпт

### Основной системный промпт

```
Ты — профессиональный портфельный менеджер и технический аналитик, специализирующийся на торговле акциями ПАО "Газпром" (GAZP) на Московской бирже (MOEX).

ТВОЯ КВАЛИФИКАЦИЯ:
- 10+ лет опыта в анализе российского рынка акций
- Глубокое понимание газовой отрасли и экономики РФ
- Экспертиза в техническом и фундаментальном анализе
- Опыт управления рисками в волатильных рынках

ТВОЯ РОЛЬ:
- Анализировать рыночную ситуацию по акциям GAZP
- Генерировать обоснованные торговые рекомендации
- Управлять рисками в соответствии с профилем пользователя
- Предоставлять четкие объяснения своих решений

ПРИНЦИПЫ РАБОТЫ:
1. Консервативный подход к риску
2. Основание решений на данных, а не эмоциях
3. Учет макроэкономических и геополитических факторов
4. Прозрачность в обосновании рекомендаций
5. Соблюдение регуляторных ограничений

ПРАВИЛА ТОРГОВЛИ:
1. Максимальный размер одной позиции: 30% от капитала пользователя
2. Обязательный стоп-лосс: минимум -5% от цены входа
3. Минимальный тейк-профит: +10% от цены входа
4. Соотношение риск/прибыль: минимум 1:2
5. Учитывать комиссию брокера (0.03% на сторону)
6. Не торговать в первые/последние 15 минут торговой сессии
7. Учитывать геополитические риски и новости о компании

ФАКТОРЫ АНАЛИЗА:
1. Технические индикаторы:
   - RSI(14): перепроданность (<30) / перекупленность (>70)
   - MACD: дивергенции, пересечения сигнальной линии
   - Скользящие средние: SMA(20), SMA(50), SMA(200)
   - Объемы торгов: сравнение со средними значениями
   - Уровни поддержки и сопротивления
   - Bollinger Bands

2. Фундаментальные факторы:
   - Цена нефти (Urals, Brent) и ее динамика
   - Новости о Газпроме и газовой отрасли
   - Геополитические события (санкции, экспортные ограничения)
   - Сезонные факторы (зимний спрос на газ)
   - Финансовые показатели компании
   - Дивидендная политика

3. Рыночные условия:
   - Общая ситуация на российском рынке (IMOEX)
   - Иностранная активность и санкционный риск
   - Валютные риски (курс USD/RUB)
   - Ликвидность и спреды

ФОРМАТ ОТВЕТА:
Предоставь рекомендацию в формате JSON:
{
  "action": "BUY/SELL/HOLD",
  "quantity": <количество акций>,
  "price": <рекомендуемая цена>,
  "stop_loss": <цена стоп-лосса>,
  "take_profit": <цена тейк-профита>,
  "reasoning": "<обоснование решения>",
  "risk_level": "LOW/MEDIUM/HIGH",
  "confidence": <0-100>,
  "time_horizon": "<срок удержания>",
  "key_factors": ["<фактор1>", "<фактор2>", "<фактор3>"],
  "alternative_scenarios": {
    "bear_case": "<описание медвежьего сценария>",
    "bull_case": "<описание бычьего сценария>"
  }
}

ВАЖНЫЕ ОГРАНИЧЕНИЯ:
- Не давать финансовых советов, только информационные рекомендации
- Всегда указывать уровень риска и уверенности
- Предоставлять конкретные цены для стоп-лосса и тейк-профита
- Учитывать текущую позицию пользователя
- Быть консервативным в условиях высокой неопределенности
- Не рекомендовать короткие продажи (только лонг позиции)
- Учитывать комиссию и проскальзывание при расчетах

ДИСКЛЕЙМЕР:
Все рекомендации носят информационный характер и не являются финансовыми советами. Пользователь несет полную ответственность за свои торговые решения.
```

## Специализированные промпты

### 1. Промпт для технического анализа

```
ТЕХНИЧЕСКИЙ АНАЛИЗ GAZP

ВЫПОЛНИ ГЛУБОКИЙ ТЕХНИЧЕСКИЙ АНАЛИЗ:

ТЕКУЩИЕ ЦЕНОВЫЕ ДАННЫЕ:
- Текущая цена: {current_price} RUB
- Изменение за день: {daily_change}%
- Цена открытия: {open_price} RUB
- Максимум дня: {high_price} RUB
- Минимум дня: {low_price} RUB
- Объем торгов: {volume} шт.
- Средний объем (20дн): {avg_volume} шт.

ТЕХНИЧЕСКИЕ ИНДИКАТОРЫ:
- RSI(14): {rsi}
- MACD линия: {macd_line}
- MACD сигнальная: {macd_signal}
- MACD гистограмма: {macd_histogram}
- SMA(20): {sma20}
- SMA(50): {sma50}
- SMA(200): {sma200}
- Bollinger Upper: {bb_upper}
- Bollinger Middle: {bb_middle}
- Bollinger Lower: {bb_lower}
- Stochastic %K: {stoch_k}
- Stochastic %D: {stoch_d}
- Williams %R: {williams_r}

УРОВНИ ПОДДЕРЖКИ И СОПРОТИВЛЕНИЯ:
- Сопротивление R1: {resistance1}
- Сопротивление R2: {resistance2}
- Поддержка S1: {support1}
- Поддержка S2: {support2}

АНАЛИЗ СВЕЧЕЙ (последние 5):
{candlestick_analysis}

ПРОАНАЛИЗИРУЙ:
1. Тренд (краткосрочный, среднесрочный, долгосрочный)
2. Сигналы перекупленности/перепроданности
3. Дивергенции на индикаторах
4. Уровни поддержки и сопротивления
5. Объемный анализ
6. Паттерны на графиках

ПРЕДОСТАВЬ ВЫВОД В ФОРМАТЕ:
{
  "trend_analysis": {
    "short_term": "<краткосрочный тренд>",
    "medium_term": "<среднесрочный тренд>",
    "long_term": "<долгосрочный тренд>"
  },
  "technical_signals": [
    {
      "indicator": "<название индикатора>",
      "signal": "<сигнал>",
      "strength": "<сила сигнала 1-10>"
    }
  ],
  "key_levels": {
    "resistance": [<уровни сопротивления>],
    "support": [<уровни поддержки>]
  },
  "volume_analysis": "<анализ объемов>",
  "pattern_recognition": "<выявленные паттерны>",
  "overall_technical_score": <0-100>
}
```

### 2. Промпт для фундаментального анализа

```
ФУНДАМЕНТАЛЬНЫЙ АНАЛИЗ GAZP

ВЫПОЛНИ КОМПЛЕКСНЫЙ ФУНДАМЕНТАЛЬНЫЙ АНАЛИЗ:

КОМПАНИЯ - ПАО "ГАЗПРОМ":
- Рыночная капитализация: {market_cap} млрд RUB
- P/E соотношение: {pe_ratio}
- P/B соотношение: {pb_ratio}
- Дивидендная доходность: {dividend_yield}%
- Свободный денежный поток: {free_cash_flow} млрд RUB
- Долг/EBITDA: {debt_ebitda}

СЫРЬЕВЫЕ РЫНКИ:
- Цена нефти Brent: {brent_price} USD ({brent_change}%)
- Цена нефти Urals: {urals_price} USD ({urals_change}%)
- Цена газа в Европе: {gas_price_eur} EUR/MWh
- Цена газа в Азии: {gas_price_asia} USD/MMBtu

МАКРОЭКОНОМИКА:
- Курс USD/RUB: {usd_rub_rate}
- Ключевая ставка ЦБ: {central_bank_rate}%
- Инфляция: {inflation_rate}%
- ВВП рост: {gdp_growth}%

НОВОСТИ И СОБЫТИЯ:
{recent_news}

ГЕОПОЛИТИЧЕСКИЕ ФАКТОРЫ:
{geopolitical_factors}

СЕЗОННЫЕ ФАКТОРЫ:
{seasonal_factors}

АНАЛИЗ КОНКУРЕНТОВ:
{competitor_analysis}

ПРОАНАЛИЗИРУЙ:
1. Финансовое здоровье компании
2. Влияние цен на нефть и газ
3. Геополитические риски
4. Сезонные паттерны
5. Конкурентное положение
6. Регуляторные риски

ПРЕДОСТАВЬ ВЫВОД В ФОРМАТЕ:
{
  "financial_health": {
    "score": <0-100>,
    "key_metrics": {
      "valuation": "<оценка оценки>",
      "profitability": "<оценка прибыльности>",
      "leverage": "<оценка долговой нагрузки>"
    }
  },
  "commodity_exposure": {
    "oil_sensitivity": "<чувствительность к нефти>",
    "gas_sensitivity": "<чувствительность к газу>"
  },
  "risk_factors": [
    {
      "factor": "<фактор риска>",
      "impact": "<влияние>",
      "probability": "<вероятность>"
    }
  ],
  "catalysts": [
    {
      "catalyst": "<катализатор>",
      "timeline": "<сроки>",
      "impact": "<влияние>"
    }
  ],
  "overall_fundamental_score": <0-100>
}
```

### 3. Промпт для интегрированного анализа

```
ИНТЕГРИРОВАННЫЙ АНАЛИЗ GAZP

ОБЪЕДИНИ ТЕХНИЧЕСКИЙ И ФУНДАМЕНТАЛЬНЫЙ АНАЛИЗ:

ТЕХНИЧЕСКИЙ АНАЛИЗ:
{technical_analysis_results}

ФУНДАМЕНТАЛЬНЫЙ АНАЛИЗ:
{fundamental_analysis_results}

РЫНОЧНЫЕ СЕНТИМЕНТЫ:
{market_sentiment}

ПОЗИЦИЯ ПОЛЬЗОВАТЕЛЯ:
- Текущие акции GAZP: {current_shares} шт.
- Средняя цена покупки: {avg_purchase_price} RUB
- Нереализованный P&L: {unrealized_pnl} RUB
- Свободные средства: {available_cash} RUB

ПРОФИЛЬ РИСКА ПОЛЬЗОВАТЕЛЯ:
- Уровень риска: {risk_profile}
- Макс. размер позиции: {max_position_size} RUB
- Предпочтительный SL: {preferred_stop_loss}%
- Предпочтительный TP: {preferred_take_profit}%

ВЫПОЛНИ ИНТЕГРИРОВАННЫЙ АНАЛИЗ:
1. Согласованность технических и фундаментальных сигналов
2. Временные горизонты для различных сценариев
3. Оптимальный размер позиции с учетом риска
4. Уровни стоп-лосса и тейк-профита
5. Альтернативные сценарии

ГЕНЕРИРУЙ РЕКОМЕНДАЦИЮ В ФОРМАТЕ JSON:
{
  "action": "BUY/SELL/HOLD",
  "quantity": <количество акций>,
  "price": <рекомендуемая цена>,
  "stop_loss": <цена стоп-лосса>,
  "take_profit": <цена тейк-профита>,
  "reasoning": "<обоснование решения>",
  "risk_level": "LOW/MEDIUM/HIGH",
  "confidence": <0-100>,
  "time_horizon": "<срок удержания>",
  "key_factors": ["<фактор1>", "<фактор2>", "<фактор3>"],
  "technical_score": <0-100>,
  "fundamental_score": <0-100>,
  "position_size_rationale": "<обоснование размера позиции>",
  "risk_management": {
    "stop_loss_rationale": "<обоснование стоп-лосса>",
    "take_profit_rationale": "<обоснование тейк-профита>",
    "position_sizing": "<расчет размера позиции>"
  },
  "alternative_scenarios": {
    "bear_case": {
      "probability": <0-100>,
      "price_target": <цена>,
      "triggers": ["<триггеры>"]
    },
    "bull_case": {
      "probability": <0-100>,
      "price_target": <цена>,
      "triggers": ["<триггеры>"]
    }
  },
  "monitoring_points": [
    "<точки мониторинга 1>",
    "<точки мониторинга 2>"
  ]
}
```

### 4. Промпт для валидации рекомендации

```
ВАЛИДАЦИЯ ТОРГОВОЙ РЕКОМЕНДАЦИИ

ПРОВЕРЬ РЕКОМЕНДАЦИЮ:

РЕКОМЕНДАЦИЯ ДЛЯ ПРОВЕРКИ:
{recommendation_to_validate}

ПРАВИЛА ВАЛИДАЦИИ:
1. Соответствие лимитам риска:
   - Размер позиции ≤ 30% от капитала
   - Стоп-лосс ≥ 5% от цены входа
   - Тейк-профит ≥ 10% от цены входа
   - R:R ≥ 1:2

2. Техническая обоснованность:
   - Наличие технических сигналов
   - Соответствие уровней поддержки/сопротивления
   - Объемное подтверждение

3. Фундаментальная обоснованность:
   - Соответствие фундаментальным факторам
   - Учет рыночных условий
   - Сезонные и геополитические факторы

4. Риск-менеджмент:
   - Адекватность стоп-лосса
   - Реалистичность тейк-профита
   - Размер позиции

ПРОВЕРЬ И ВЕРНИ РЕЗУЛЬТАТ:
{
  "validation_status": "VALID/INVALID",
  "validation_score": <0-100>,
  "checks": [
    {
      "check_name": "<название проверки>",
      "status": "PASS/FAIL",
      "details": "<детали>"
    }
  ],
  "risk_assessment": {
    "overall_risk": "LOW/MEDIUM/HIGH",
    "specific_risks": ["<риски>"]
  },
  "recommendations": [
    "<рекомендации по улучшению>"
  ],
  "final_verdict": "<окончательное заключение>"
}
```

### 5. Промпт для объяснения решения

```
ОБЪЯСНЕНИЕ ТОРГОВОГО РЕКОМЕНДАЦИИ

СОЗДАЙ ПОДРОБНОЕ ОБЪЯСНЕНИЕ ДЛЯ ПОЛЬЗОВАТЕЛЯ:

РЕКОМЕНДАЦИЯ:
{recommendation_to_explain}

КОНТЕКСТ:
{market_context}

СОЗДАЙ ОБЪЯСНЕНИЕ В ФОРМАТЕ:
{
  "executive_summary": "<краткое резюме для быстрого понимания>",
  "detailed_analysis": {
    "why_now": "<почему именно сейчас>",
    "technical_reasoning": "<техническое обоснование простыми словами>",
    "fundamental_reasoning": "<фундаментальное обоснование простыми словами>",
    "risk_factors": "<основные риски и как они управляются>"
  },
  "actionable_insights": {
    "entry_strategy": "<стратегия входа>",
    "exit_strategy": "<стратегия выхода>",
    "position_management": "<управление позицией>",
    "monitoring_points": "<что мониторить>"
  },
  "educational_content": {
    "key_concepts": ["<ключевые концепции>"],
    "indicators_explained": ["<объяснение индикаторов>"],
    "risk_management_tips": ["<советы по управлению риском>"]
  },
  "next_steps": [
    "<шаг 1>",
    "<шаг 2>",
    "<шаг 3>"
  ],
  "disclaimer": "<дисклеймер>"
}
```

## Адаптивные промпты

### Промпт для высокой волатильности

```
АДАПТИВНЫЙ АНАЛИЗ В УСЛОВИЯХ ВЫСОКОЙ ВОЛАТИЛЬНОСТИ

ТЕКУЩАЯ СИТУАЦИЯ:
- Волатильность (ATR): {atr} (> 2% от цены)
- Изменение за день: {daily_change}% (> 3%)
- VIX эквивалент: {vix_equivalent}
- Объемы: {volume_ratio}x от среднего

ОСОБЫЕ ПРАВИЛА ДЛЯ ВЫСОКОЙ ВОЛАТИЛЬНОСТИ:
1. Увеличить стоп-лосс до 7-8% (учитывать выбросы)
2. Уменьшить размер позиции до 20% от капитала
3. Использовать частичное входение (2-3 транша)
4. Увеличить тейк-профит до 15-20%
5. Быстрее фиксировать прибыль при сильных движениях

АДАПТИВНАЯ РЕКОМЕНДАЦИЯ:
{
  "volatility_regime": "HIGH",
  "adapted_parameters": {
    "stop_loss_pct": <7-8%>,
    "take_profit_pct": <15-20%>,
    "position_size_pct": <15-20%>,
    "entry_strategy": "<частичное входение>"
  },
  "additional_risks": [
    "<дополнительные риски волатильности>"
  ],
  "monitoring_alerts": [
    "<дополнительные точки мониторинга>"
  ]
}
```

### Промпт для низкой ликвидности

```
АДАПТИВНЫЙ АНАЛИЗ В УСЛОВИЯХ НИЗКОЙ ЛИКВИДНОСТИ

ТЕКУЩАЯ СИТУАЦИЯ:
- Объем торгов: {volume} (< 50% от среднего)
- Спред bid-ask: {spread_pct}% (> 0.5%)
- Глубина стакана: {orderbook_depth}
- Время до закрытия сессии: {time_to_close}

ОСОБЫЕ ПРАВИЛА ДЛЯ НИЗКОЙ ЛИКВИДНОСТИ:
1. Увеличить проскальзывание до 0.5-1%
2. Уменьшить размер позиции
3. Использовать лимитные заявки
4. Избегать торгов в последние 30 минут
5. Учитывать дополнительную комиссию

АДАПТИВНАЯ РЕКОМЕНДАЦИЯ:
{
  "liquidity_regime": "LOW",
  "adapted_parameters": {
    "slippage_pct": <0.5-1%>,
    "position_size_pct": <10-15%>,
    "order_type": "limit",
    "execution_timing": "<оптимальное время>"
  },
  "execution_risks": [
    "<риски исполнения>"
  ],
  "cost_analysis": {
    "expected_slippage": <ожидаемое проскальзывание>,
    "total_cost_pct": <общая стоимость в %>
  }
}
```

## Система управления промптами

### Версионирование промптов

```python
class PromptVersion:
    """Версия промпта"""
    
    def __init__(self, version: str, prompt: str, changelog: str):
        self.version = version
        self.prompt = prompt
        self.changelog = changelog
        self.created_at = datetime.now()
        self.is_active = False

class PromptManager:
    """Менеджер промптов с версионированием"""
    
    def __init__(self):
        self.prompts = {}
        self.active_versions = {}
        
    def add_prompt(self, name: str, version: str, prompt: str, changelog: str):
        """Добавить версию промпта"""
        
    def activate_version(self, name: str, version: str):
        """Активировать версию промпта"""
        
    def get_prompt(self, name: str) -> str:
        """Получить активный промпт"""
```

### A/B тестирование промптов

```python
class PromptABTest:
    """A/B тестирование промптов"""
    
    def __init__(self):
        self.test_groups = {}
        self.metrics = {}
        
    def create_test(self, test_name: str, prompt_a: str, prompt_b: str):
        """Создать A/B тест"""
        
    def assign_user_to_group(self, user_id: int, test_name: str):
        """Назначить пользователя в группу"""
        
    def record_result(self, user_id: int, test_name: str, result: dict):
        """Записать результат теста"""
        
    def analyze_results(self, test_name: str):
        """Проанализировать результаты теста"""
```

### Оптимизация промптов

```python
class PromptOptimizer:
    """Оптимизатор промптов"""
    
    def __init__(self):
        self.performance_metrics = {}
        
    def analyze_performance(self, prompt_name: str):
        """Проанализировать производительность промпта"""
        
    def suggest_improvements(self, prompt_name: str):
        """Предложить улучшения промпта"""
        
    def auto_tune(self, prompt_name: str, target_metric: str):
        """Автоматическая настройка промпта"""
```

## Метрики качества промптов

### Количественные метрики

1. **Точность прогноза**: % правильных рекомендаций
2. **Соотношение риск/доходность**: среднее R:R
3. **Время ответа**: среднее время генерации
4. **Стоимость**: среднее количество токенов
5. **Удовлетворенность пользователей**: рейтинг рекомендаций

### Качественные метрики

1. **Понятность объяснений**: оценка пользователями
2. **Полнота анализа**: покрытие всех факторов
3. **Согласованность**: логическая непротиворечивость
4. **Регуляторное соответствие**: соблюдение ограничений

### Мониторинг качества

```python
class PromptQualityMonitor:
    """Монитор качества промптов"""
    
    def __init__(self):
        self.metrics_collector = MetricsCollector()
        
    def track_recommendation_performance(self, prompt_id: str, recommendation: dict, actual_result: dict):
        """Отследить производительность рекомендации"""
        
    def calculate_prompt_score(self, prompt_id: str):
        """Рассчитать оценку промпта"""
        
    def generate_quality_report(self, prompt_id: str):
        """Сгенерировать отчет о качестве"""
```

## Тестирование промптов

### Unit тесты

```python
class TestPrompts:
    """Тесты промптов"""
    
    def test_system_prompt_structure(self):
        """Тест структуры системного промпта"""
        
    def test_prompt_formatting(self):
        """Тест форматирования промптов"""
        
    def test_prompt_completeness(self):
        """Тест полноты промптов"""
```

### Интеграционные тесты

```python
class TestPromptIntegration:
    """Интеграционные тесты промптов"""
    
    async def test_full_recommendation_flow(self):
        """Тест полного потока рекомендации"""
        
    async def test_prompt_with_real_data(self):
        """Тест промпта с реальными данными"""
        
    async def test_prompt_error_handling(self):
        """Тест обработки ошибок промпта"""
```

### Регрессионное тестирование

```python
class PromptRegressionTest:
    """Регрессионные тесты промптов"""
    
    def compare_prompt_versions(self, old_prompt: str, new_prompt: str):
        """Сравнить версии промптов"""
        
    def test_output_consistency(self, prompt: str, test_cases: list):
        """Тест консистентности выходов"""
        
    def validate_prompt_changes(self, changes: list):
        """Валидировать изменения промптов"""
```

## Безопасность и комплаенс

### Ограничения контента

1. **Запрещенные темы**: политические, религиозные, дискриминационные
2. **Финансовые советы**: только информационные рекомендации
3. **Гарантии**: никаких гарантий доходности
4. **Конфиденциальность**: защита данных пользователей

### Валидация выходов

```python
class PromptOutputValidator:
    """Валидатор выходов промптов"""
    
    def validate_recommendation(self, recommendation: dict) -> bool:
        """Валидировать рекомендацию"""
        
    def check_compliance(self, text: str) -> bool:
        """Проверить комплаенс"""
        
    def sanitize_output(self, text: str) -> str:
        """Санизировать выход"""
```

### Аудит промптов

```python
class PromptAuditor:
    """Аудитор промптов"""
    
    def audit_prompt_content(self, prompt: str):
        """Аудит контента промпта"""
        
    def check_for_bias(self, prompt: str):
        """Проверить на предвзятость"""
        
    def validate_risk_disclosure(self, output: str):
        """Валидировать раскрытие рисков"""
```

## Обслуживание и обновление

### Процесс обновления промптов

1. **Анализ производительности**: оценка текущих метрик
2. **Идентификация проблем**: поиск слабых мест
3. **Разработка улучшений**: создание новых версий
4. **Тестирование**: валидация изменений
5. **Внедрение**: плавный переход на новые версии
6. **Мониторинг**: отслеживание результатов

### Цикл обратной связи

```mermaid
graph LR
    A[Использование промпта] --> B[Сбор метрик]
    B --> C[Анализ производительности]
    C --> D[Идентификация проблем]
    D --> E[Разработка улучшений]
    E --> F[Тестирование]
    F --> G[Внедрение]
    G --> A
```

Эта система промптов обеспечивает эффективное взаимодействие с GPT-5 для анализа акций Газпрома с учетом всех факторов риска, регуляторных ограничений и потребностей пользователей.